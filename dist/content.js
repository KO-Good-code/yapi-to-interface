!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self)["yapi-to-interface"]=t()}(this,function(){const m=e=>e.substr(0,1).toUpperCase()+e.slice(1),f=e=>{var t=document.createElement("textarea");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)},T=e=>{var t=document.createElement("div"),r=(t.classList="to-ts-msg",document.createElement("img")),n=(r.src={success:"./assets/img/success.png",error:"./assets/img/error.png"}[e.type],document.createElement("div"));n.innerText=e.text||"success~",t.appendChild(r),t.appendChild(n),document.body.appendChild(t),setTimeout(function(){t.classList="to-ts-msg is-leaving",t.addEventListener("transitionend",function(){document.body.contains(t)&&document.body.removeChild(t)})},2e3)},y=(r,e=" | ")=>((r=r instanceof Array?r:r.split(",")).forEach((e,t)=>{"integer"===e&&(r[t]="number")}),r.join(e)),r=new XMLHttpRequest,e=()=>{var e=window.location.pathname.replace(/\/project\/\d+\/interface\/api\//,"");const t="https://"+window.location.host+"/api/interface/get?id="+e;return new Promise(e=>{r.open("GET",t,!0),r.send(),r.onreadystatechange=()=>{4==r.readyState&&200==r.status&&e(r.responseText)}})},b={resBtn:{field:"res_body",innerText:"返回值转换"},bodyBtn:{field:"req_body_other",innerText:"Body参数转换"},queryBtn:{field:"req_query",innerText:"Query参数转换"}};class t{constructor(e){this.exportStr="",this.API_URL=e}deepClone(e){var t,r=e instanceof Array?[]:{};for(t in e)e[t]&&"object"==typeof e[t]?r[t]=this.deepClone(e[t]):r[t]=e[t];return r}deepCloneToType(e){var t,r,n=e instanceof Array?[]:{};for(t in e)e[t]&&"object"==typeof e[t]?n[t]=this.deepCloneToType(e[t]):(r=typeof e[t],n[t]=this.judgeValueType(r));return n}judgeValueType(e){let t=e;switch(e){case"number":t="number";break;case"string":t="string";break;case"boolean":t="boolean";break;default:t="any"}return t}formatToTsInterface(n,s){let o=this.deepClone(n),t=(s=m(s),Object.keys(n).forEach(e=>{var t,r=""+s+m(e);"object"==typeof n[e]&&(n[e]instanceof Array?0===n[e].length?o[e]="any[]":"object"==typeof n[e][0]?(o[e]=r+"[]",this.formatToTsInterface(n[e][0],r)):(t=typeof n[e][0],o[e]=t+"[]"):(o[e]=r,this.formatToTsInterface(n[e],r)))}),"");Object.keys(o).forEach(e=>{t+=`
  ${e}: ${o[e]}, `}),this.generateExportStr(s,t)}jsonSchemaToTsInterface(e,t){let r=this.deepClone(e);for(var n in t=m(t),e){var s=""+t+m(n),{type:o,description:i,properties:a,items:c,required:d}=e[n];if("required"!==n&&(r[n]={type:y(o),description:i},r.required)&&r.required.includes(n)&&(r[n].required=!0),"object"===o&&(r[n].type=s),"array"===o){var p=c&&c.type?c.type:"any";switch(p){case"object":case"array":r[n].type=s+"[]";var{properties:l,required:u}=c;this.jsonSchemaToTsInterface(Object.assign(Object.assign({},l),{required:u}),s);break;default:r[n].type=p+"[]"}}a&&(a.required=d,this.jsonSchemaToTsInterface(a,s),delete r[n].properties)}let h="";Object.keys(r).forEach(e=>{r[e].description&&(h+=`
  // ${r[e].description} `),r[e].type&&(h+=`
  ${e}${r[e].required?"":"?"}: ${r[e].type}, `)}),this.generateExportStr(t,h)}queryToTsInterface(e,t){let n="";t=m(t),e.forEach(e=>{var{desc:e,name:t,required:r}=e;e&&(n+=`
 // `+e),n+=`
 ${t}${"1"!==r?"?":""}: string,`}),this.generateExportStr(t,n)}generateExportStr(e,t){this.exportStr=this.KEY_WORD+"interface "+e+" { "+t+"\n}\n\n"+this.exportStr}compile(e,t,r,n,s){switch(this.exportStr="",this.KEY_WORD=n?"export ":"",r){case"json_schema":this.jsonSchemaToTsInterface(e,t);break;case"form":case"query":this.queryToTsInterface(e,t);break;default:var o=this.deepCloneToType(e);this.formatToTsInterface(o,t)}return`// ${s}-${this.API_URL}
`+this.exportStr}}const n=new class{constructor(){this.toTsCompile=new t(location.href)}createElementFun(e){var t=document.createElement(e.elem);return t.innerText=e.innerText||"",t.classList=e.classList||"",t.type=e.type||"",t}contentLoad(e){var e=e.target,t=this.createElementFun({classList:"to-ts"}),r=this.creatBtnWrapper(),n=this.hasExportToggle(),s=this.createResBtn(),o=this.createBodyBtn(),i=this.createQueryBtn();t.appendChild(r),t.appendChild(n),t.appendChild(s),t.appendChild(o),t.appendChild(i),e.body.appendChild(t)}creatBtnWrapper(){return this.createElementFun({elem:"h4",classList:"to-ts-title",innerText:"接口转为ts interface"})}createResBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-res-btn",innerText:"返回值转换"});return e.onclick=()=>{this.clickCallBack(e,"resBtn")},e}hasExportToggle(){var e=this.createElementFun({elem:"input",type:"checkbox",classList:"has-export-toggle"}),t=this.createElementFun({elem:"div",classList:"has-export-wrapper",innerText:"export关键字"});return t.appendChild(e),e.onclick=e=>{this.hasExport=e.target.checked},t}createBodyBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-req-btn",innerText:"Body参数转换"});return e.onclick=()=>{this.clickCallBack(e,"bodyBtn")},e}createQueryBtn(){const e=this.createElementFun({elem:"button",classList:"to-ts-query-btn",innerText:"Query参数转换"});return e.onclick=()=>{this.clickCallBack(e,"queryBtn")},e}clickCallBack(h,y){h.innerText="转换中...",e().then(n=>{try{var s=(n=JSON.parse(n).data).title,o=n[b[y].field],i="object"==typeof o?JSON.stringify(o):o;let e=new Function("return "+i)(),t="";var a,c,d=n.path.replace(".do","").split("/"),p=d[d.length-1];let r=p;if(-1<p.indexOf("-")){const u=p.split("-");u.forEach((e,t)=>{0<t&&(u[t]=m(e))}),r=u.join("")}"resBtn"===y?n.res_body_is_json_schema&&"json"===n.res_body_type&&(a=e.required,(e=e.properties).required=a,t="json_schema"):"bodyBtn"===y?(r+="Body","form"===n.req_body_type?(e=n.req_body_form,t="form"):n.req_body_is_json_schema&&(c=e.required,(e=e.properties).required=c,t="json_schema")):"queryBtn"===y&&(r+="Query",t="query");var l=this.toTsCompile.compile(e,r,t,this.hasExport,s);f(l),h.innerText=b[y].innerText,T({text:"复制成功",type:"success"})}catch(e){console.error(e),h.innerText=b[y].innerText,T({text:"生成失败, 请检查是否有"+b[y].innerText,type:"error"})}})}};return document.addEventListener("DOMContentLoaded",function(e){n.contentLoad(e)}),n});
